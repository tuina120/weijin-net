name: Build luci-app-weijin (Weijin Net)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        ARCH: [aarch64_generic, x86_64]

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential tar gzip binutils

    - name: Set version
      id: vars
      run: |
        VERSION="dev-${GITHUB_RUN_NUMBER}"
        echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

    - name: Build IPK
      run: |
        PKG="luci-app-weijin"
        VERSION="${{ steps.vars.outputs.version }}"
        ARCH="${{ matrix.ARCH }}"

        echo "=== Building ${PKG} for ${ARCH}, version ${VERSION} ==="

        # Create directory structure
        mkdir -p build_ipk/CONTROL
        mkdir -p build_ipk/data

cat <<EOF > build_ipk/CONTROL/control
Package: ${PKG}
Version: ${VERSION}
Depends: libc, luci-base
Section: luci
Architecture: ${ARCH}
Maintainer: Weijin Net
Description: Weijin Net - Tailscale 智能出口选择插件（自动测速 + 智能切换）
EOF

        # copy plugin files
        cp -r luci-app-weijin/* build_ipk/data/

        # pack ipk
        cd build_ipk
        tar -czf control.tar.gz CONTROL
        tar -czf data.tar.gz data
        echo "2.0" > debian-binary

        mkdir -p ../output
        ar r ../output/${PKG}_${VERSION}_${ARCH}.ipk debian-binary control.tar.gz data.tar.gz

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: weijin-net-ipk-${{ matrix.ARCH }}
        path: output/*.ipk
