name: Build luci-app-weijin (Weijin Net)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        ARCH: [aarch64_generic, x86_64]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential tar gzip ar binutils

    - name: Set version
      id: vars
      run: |
        VERSION="dev-${GITHUB_RUN_NUMBER}"
        echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

    - name: Build IPK
      run: |
        PKG="luci-app-weijin"
        VERSION="${{ steps.vars.outputs.version }}"
        ARCH="${{ matrix.ARCH }}"

        echo "Building $PKG for $ARCH, version $VERSION"

        mkdir -p ipk/CONTROL
        mkdir -p ipk/data/usr/lib/lua/luci
        mkdir -p ipk/data/usr/bin
        mkdir -p ipk/data/etc/config
        mkdir -p ipk/data/www/luci-static/weijin

        # ---- 使用 echo 写 CONTROL 文件 ----
        echo "Package: ${PKG}" > ipk/CONTROL/control
        echo "Version: ${VERSION}" >> ipk/CONTROL/control
        echo "Depends: libc, luci-base" >> ipk/CONTROL/control
        echo "Section: luci" >> ipk/CONTROL/control
        echo "Architecture: ${ARCH}" >> ipk/CONTROL/control
        echo "Maintainer: Weijin Net" >> ipk/CONTROL/control
        echo "Description: Weijin Net - Tailscale 智能出口选择插件（自动测速 + 智能切换）" >> ipk/CONTROL/control

        # ---- 复制插件文件 ----
        cp -r luci-app-weijin/luasrc/* ipk/data/usr/lib/lua/luci/ || true
        cp -r luci-app-weijin/htdocs/luci-static/weijin/* ipk/data/www/luci-static/weijin/ || true
        cp -r luci-app-weijin/root/* ipk/data/ || true

        # ---- 打包 control.tar.gz ----
        cd ipk/CONTROL
        tar -czf ../control.tar.gz .
        cd -

        # ---- 打包 data.tar.gz ----
        cd ipk/data
        tar -czf ../data.tar.gz .
        cd -

        # ---- 写 debian-binary ----
        echo "2.0" > ipk/debian-binary

        mkdir -p output
        ar r output/${PKG}_${VERSION}_${ARCH}.ipk ipk/debian-binary ipk/control.tar.gz ipk/data.tar.gz

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: weijin-net-ipk-${{ matrix.ARCH }}
        path: output/*.ipk
